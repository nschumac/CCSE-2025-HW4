name: assignment4

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Record start time and submitters
        run: |
          echo "$(date -Iminutes)" > start_time.txt
          echo "nikolai Schumacher, livia Wyler" > submitters.txt

      - name: Build pet-store image
        id: build-pet-store
        run: |
          cd pet-store
          if docker build -t pet-store:latest .; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Build pet-order image
        id: build-pet-order
        run: |
          cd pet-order
          if docker build -t pet-order:latest .; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate build log
        run: |
          if [ "${{ steps.build-pet-store.outputs.success }}" = "true" ]; then
            echo "image pet-store successfully built;" >> log.txt
          else
            echo "image pet-store not able to be built;" >> log.txt
          fi
          if [ "${{ steps.build-pet-order.outputs.success }}" = "true" ]; then
            echo "image pet-order successfully built;" >> log.txt
          else
            echo "image pet-order not able to be built;" >> log.txt
          fi

      - name: Save Docker images
        run: |
          docker save pet-store:latest -o pet-store.tar
          docker save pet-order:latest -o pet-order.tar

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: |
            pet-store.tar
            pet-order.tar
            log.txt
            start_time.txt
            submitters.txt

      - name: Save build status
        run: |
          echo "${{ steps.build-pet-store.outputs.success }}" > build_pet_store_status.txt
          echo "${{ steps.build-pet-order.outputs.success }}" > build_pet_order_status.txt

      - name: Upload build status
        uses: actions/upload-artifact@v4
        with:
          name: build-status
          path: |
            build_pet_store_status.txt
            build_pet_order_status.txt

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Load Docker images
        run: |
          docker load -i pet-store.tar
          docker load -i pet-order.tar

      - name: Create Docker network
        run: docker network create petstore_net

      - name: Start MongoDB shared
        id: start-mongo-shared
        run: |
          if docker run -d --name mongo-shared \
            --network petstore_net \
            -e MONGO_INITDB_DATABASE=petstore_shared \
            mongo:latest; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Start MongoDB order
        id: start-mongo-order
        run: |
          if docker run -d --name mongo-order \
            --network petstore_net \
            -e MONGO_INITDB_DATABASE=pet_order_db \
            mongo:latest; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Wait for MongoDB
        run: |
          sleep 10
          docker exec mongo-shared mongosh --eval "db.runCommand({ ping: 1 })" || true
          docker exec mongo-order mongosh --eval "db.runCommand({ ping: 1 })" || true

      - name: Start pet-store #1
        id: start-pet-store-1
        run: |
          if docker run -d --name pet-store1 \
            --network petstore_net \
            -p 5001:5001 \
            -e MONGODB_URI=mongodb://mongo-shared:27017/ \
            -e PORT=5001 \
            -e STORE_ID=1 \
            -e NINJA_API_KEY=${{ secrets.NINJA_API_KEY }} \
            pet-store:latest; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Start pet-store #2
        id: start-pet-store-2
        run: |
          if docker run -d --name pet-store2 \
            --network petstore_net \
            -p 5002:5002 \
            -e MONGODB_URI=mongodb://mongo-shared:27017/ \
            -e PORT=5002 \
            -e STORE_ID=2 \
            -e NINJA_API_KEY=${{ secrets.NINJA_API_KEY }} \
            pet-store:latest; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Start pet-order
        id: start-pet-order
        run: |
          if docker run -d --name pet-order \
            --network petstore_net \
            -p 5003:5003 \
            -e MONGODB_URI=mongodb://mongo-order:27017/ \
            -e PORT=5003 \
            -e PET_STORE_1_URL=http://pet-store1:5001 \
            -e PET_STORE_2_URL=http://pet-store2:5002 \
            pet-order:latest; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Download build status
        uses: actions/download-artifact@v4
        with:
          name: build-status

      - name: Update log with build and container status
        run: |
          # Line 1: timestamp
          cat start_time.txt > log.txt

          # Line 2: submitters
          cat submitters.txt >> log.txt

          # Line 3: both build statuses on ONE line
          build_line=""
          if [ "$(cat build_pet_store_status.txt)" = "true" ]; then
            build_line="${build_line}image pet-store successfully built; "
          else
            build_line="${build_line}image pet-store not able to be built; "
          fi
          if [ "$(cat build_pet_order_status.txt)" = "true" ]; then
            build_line="${build_line}image pet-order successfully built;"
          else
            build_line="${build_line}image pet-order not able to be built;"
          fi
          echo "$build_line" >> log.txt

          # Line 4: all container statuses on ONE line
          container_line=""
          if docker ps | grep -q pet-store1; then
            container_line="${container_line}Container pet-store #1 up and running; "
          else
            container_line="${container_line}Container pet-store #1 failed to run; "
          fi
          if docker ps | grep -q pet-store2; then
            container_line="${container_line}Container pet-store #2 up and running; "
          else
            container_line="${container_line}Container pet-store #2 failed to run; "
          fi
          if docker ps | grep -q " pet-order"; then
            container_line="${container_line}Container pet-order up and running;"
          else
            container_line="${container_line}Container pet-order failed to run;"
          fi
          echo "$container_line" >> log.txt

      - name: Wait for services
        run: |
          sleep 5
          curl -f http://localhost:5001/pet-types || exit 1
          curl -f http://localhost:5002/pet-types || exit 1
          curl -f http://localhost:5003/transactions -H "OwnerPC: LovesPetsL2M3n4!" || exit 1

      - name: Install test dependencies
        run: |
          pip install pytest requests

      - name: Run pytest
        id: pytest
        run: |
          pytest -v tests/assn4_tests.py > assn4_test_results.txt 2>&1
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Update log with test results
        if: always()
        run: |
          # Line 5: pytest status
          if [ "${{ steps.pytest.outputs.exit_code }}" = "0" ]; then
            echo "All pytests succeeded" >> log.txt
          else
            echo "pytests failed" >> log.txt
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            assn4_test_results.txt
            log.txt

      - name: Stop containers
        if: always()
        run: |
          docker stop pet-order pet-store1 pet-store2 mongo-order mongo-shared || true
          docker rm pet-order pet-store1 pet-store2 mongo-order mongo-shared || true

  query:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: Load Docker images and start services
        run: |
          docker load -i pet-store.tar
          docker load -i pet-order.tar
          docker network create petstore_net
          docker run -d --name mongo-shared --network petstore_net mongo:latest
          docker run -d --name mongo-order --network petstore_net mongo:latest
          sleep 10
          docker run -d --name pet-store1 --network petstore_net -p 5001:5001 \
            -e MONGODB_URI=mongodb://mongo-shared:27017/ \
            -e PORT=5001 \
            -e STORE_ID=1 \
            -e NINJA_API_KEY=${{ secrets.NINJA_API_KEY }} \
            pet-store:latest
          docker run -d --name pet-store2 --network petstore_net -p 5002:5002 \
            -e MONGODB_URI=mongodb://mongo-shared:27017/ \
            -e PORT=5002 \
            -e STORE_ID=2 \
            -e NINJA_API_KEY=${{ secrets.NINJA_API_KEY }} \
            pet-store:latest
          docker run -d --name pet-order --network petstore_net -p 5003:5003 \
            -e MONGODB_URI=mongodb://mongo-order:27017/ \
            -e PORT=5003 \
            -e PET_STORE_1_URL=http://pet-store1:5001 \
            -e PET_STORE_2_URL=http://pet-store2:5002 \
            pet-order:latest
          sleep 5

      - name: Setup data
        id: setup-data
        continue-on-error: true
        run: |
          python3 scripts/setup_data.py > setup_data.log 2>&1
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Process queries
        id: process-queries
        continue-on-error: true
        run: |
          python3 scripts/query_processor.py query.txt response.txt > query_processor.log 2>&1
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Upload query results and logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: query-results
          path: |
            response.txt
            setup_data.log
            query_processor.log

      - name: Check query job success
        if: always()
        run: |
          if [ "${{ steps.setup-data.outputs.exit_code }}" != "0" ]; then
            echo "Setup data failed"
            exit 1
          fi
          if [ "${{ steps.process-queries.outputs.exit_code }}" != "0" ]; then
            echo "Query processing failed"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          docker stop pet-order pet-store1 pet-store2 mongo-order mongo-shared || true
          docker rm pet-order pet-store1 pet-store2 mongo-order mongo-shared || true
          docker network rm petstore_net || true